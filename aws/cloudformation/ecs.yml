AWSTemplateFormatVersion: "2010-09-09"
Description: ECS Fargate service for bound-fastapi

Parameters:
  EnvironmentName:
    Type: String
    Default: production

  ContainerImage:
    Type: String
    Description: Docker image URI (e.g. 123456789.dkr.ecr.us-east-1.amazonaws.com/bound-fastapi:latest)

  ContainerPort:
    Type: Number
    Default: 8000

  DesiredCount:
    Type: Number
    Default: 2

  DeploymentControllerType:
    Type: String
    Default: CODE_DEPLOY
    AllowedValues:
      - CODE_DEPLOY
      - ECS

  DBMasterPassword:
    Type: String
    NoEcho: true

  AcmCertificateArn:
    Type: String
    Default: ""
    Description: ACM certificate ARN for the ALB HTTPS listener

  EnableHttpRedirect:
    Type: String
    Default: "true"
    AllowedValues:
      - "true"
      - "false"

  DatabaseUrlSecretArn:
    Type: String
    Default: ""
    Description: Optional Secrets Manager ARN containing DATABASE_URL

  JwtSecretArn:
    Type: String
    Default: ""
    Description: Optional Secrets Manager ARN containing JWT_SECRET_KEY

  ResendApiKeyArn:
    Type: String
    Default: ""
    Description: Optional Secrets Manager ARN containing RESEND_API_KEY

  ResendFromEmailArn:
    Type: String
    Default: ""
    Description: Optional Secrets Manager ARN containing RESEND_FROM_EMAIL

  FrontendUrl:
    Type: String
    Default: "https://bound.sh"

  ResendFromName:
    Type: String
    Default: "bound"

  CookieDomain:
    Type: String
    Default: ""

  CookieSecure:
    Type: String
    Default: "false"
    AllowedValues:
      - "true"
      - "false"

  MinCapacity:
    Type: Number
    Default: 2

  MaxCapacity:
    Type: Number
    Default: 6

  CpuTarget:
    Type: Number
    Default: 70

  TestListenerPort:
    Type: Number
    Default: 9000

Conditions:
  HasDatabaseUrlSecret: !Not [!Equals [!Ref DatabaseUrlSecretArn, ""]]
  HasJwtSecret: !Not [!Equals [!Ref JwtSecretArn, ""]]
  HasResendApiKey: !Not [!Equals [!Ref ResendApiKeyArn, ""]]
  HasResendFromEmail: !Not [!Equals [!Ref ResendFromEmailArn, ""]]
  EnableHttpRedirectCondition: !Equals [!Ref EnableHttpRedirect, "true"]
  UseCodeDeploy: !Equals [!Ref DeploymentControllerType, "CODE_DEPLOY"]

Resources:
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub ${EnvironmentName}-bound-cluster

  ECSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for ECS tasks
      VpcId: !ImportValue
        Fn::Sub: ${EnvironmentName}-VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: !Ref ContainerPort
          ToPort: !Ref ContainerPort
          SourceSecurityGroupId: !Ref ALBSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-ecs-sg

  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for ALB
      VpcId: !ImportValue
        Fn::Sub: ${EnvironmentName}-VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: !Ref TestListenerPort
          ToPort: !Ref TestListenerPort
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-alb-sg

  ALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub ${EnvironmentName}-bound-alb
      Subnets:
        - !ImportValue
          Fn::Sub: ${EnvironmentName}-PublicSubnetA
        - !ImportValue
          Fn::Sub: ${EnvironmentName}-PublicSubnetB
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-bound-alb

  BlueTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub ${EnvironmentName}-bound-blue
      Port: !Ref ContainerPort
      Protocol: HTTP
      VpcId: !ImportValue
        Fn::Sub: ${EnvironmentName}-VPCId
      TargetType: ip
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3

  GreenTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub ${EnvironmentName}-bound-green
      Port: !Ref ContainerPort
      Protocol: HTTP
      VpcId: !ImportValue
        Fn::Sub: ${EnvironmentName}-VPCId
      TargetType: ip
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3

  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ALB
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref AcmCertificateArn
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref BlueTargetGroup

  ALBHttpListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: EnableHttpRedirectCondition
    Properties:
      LoadBalancerArn: !Ref ALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: "443"
            StatusCode: HTTP_301

  ALBTestListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ALB
      Port: !Ref TestListenerPort
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref GreenTargetGroup

  TaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-bound-execution-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Policies:
        - PolicyName: SecretsManagerRead
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: "*"
        - PolicyName: ECSExecSSM
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ssmmessages:CreateControlChannel
                  - ssmmessages:CreateDataChannel
                  - ssmmessages:OpenControlChannel
                  - ssmmessages:OpenDataChannel
                Resource: "*"

  TaskRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-bound-task-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      # Policies:
      #   - PolicyName: S3Access
      #     PolicyDocument:
      #       Version: "2012-10-17"
      #       Statement:
      #         - Effect: Allow
      #           Action:
      #             - s3:GetObject
      #             - s3:PutObject
      #             - s3:DeleteObject
      #             - s3:ListBucket
      #           Resource:
      #             - !ImportValue
      #               Fn::Sub: ${EnvironmentName}-StorageBucketArn
      #             - !Sub
      #               - ${BucketArn}/*
      #               - BucketArn: !ImportValue
      #                   Fn::Sub: ${EnvironmentName}-StorageBucketArn

  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /ecs/${EnvironmentName}-bound
      RetentionInDays: 30

  TaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub ${EnvironmentName}-bound
      Cpu: "256"
      Memory: "512"
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !GetAtt TaskExecutionRole.Arn
      TaskRoleArn: !GetAtt TaskRole.Arn
      ContainerDefinitions:
        - Name: bound-fastapi
          Image: !Ref ContainerImage
          PortMappings:
            - ContainerPort: !Ref ContainerPort
          Environment:
            - !If
              - HasDatabaseUrlSecret
              - !Ref AWS::NoValue
              - Name: DATABASE_URL
                Value: !Sub
                  - postgresql+asyncpg://postgres:${DBPassword}@${DBHost}:5432/bound
                  - DBPassword: !Ref DBMasterPassword
                    DBHost: !ImportValue
                      Fn::Sub: ${EnvironmentName}-DBEndpoint
            - Name: FRONTEND_URL
              Value: !Ref FrontendUrl
            - Name: RESEND_FROM_NAME
              Value: !Ref ResendFromName
            - Name: COOKIE_DOMAIN
              Value: !Ref CookieDomain
            - Name: COOKIE_SECURE
              Value: !Ref CookieSecure
            # - Name: S3_BUCKET_NAME
            #   Value: !ImportValue
            #     Fn::Sub: ${EnvironmentName}-StorageBucket
            # - Name: AWS_REGION
            #   Value: !Ref AWS::Region
          Secrets:
            - !If
              - HasDatabaseUrlSecret
              - Name: DATABASE_URL
                ValueFrom: !Ref DatabaseUrlSecretArn
              - !Ref AWS::NoValue
            - !If
              - HasJwtSecret
              - Name: JWT_SECRET_KEY
                ValueFrom: !Ref JwtSecretArn
              - !Ref AWS::NoValue
            - !If
              - HasResendApiKey
              - Name: RESEND_API_KEY
                ValueFrom: !Ref ResendApiKeyArn
              - !Ref AWS::NoValue
            - !If
              - HasResendFromEmail
              - Name: RESEND_FROM_EMAIL
                ValueFrom: !Ref ResendFromEmailArn
              - !Ref AWS::NoValue
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs

  ECSService:
    Type: AWS::ECS::Service
    DependsOn: ALBListener
    Properties:
      ServiceName: !Sub ${EnvironmentName}-bound-service
      Cluster: !Ref ECSCluster
      TaskDefinition: !Ref TaskDefinition
      DesiredCount: !Ref DesiredCount
      DeploymentController:
        Type: !Ref DeploymentControllerType
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          Subnets:
            - !ImportValue
              Fn::Sub: ${EnvironmentName}-PrivateSubnetA
            - !ImportValue
              Fn::Sub: ${EnvironmentName}-PrivateSubnetB
          SecurityGroups:
            - !Ref ECSSecurityGroup
      LoadBalancers:
        - ContainerName: bound-fastapi
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref BlueTargetGroup

  AutoScalingRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-bound-autoscaling-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: application-autoscaling.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceAutoscaleRole

  ECSServiceScalingTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    DependsOn: ECSService
    Properties:
      MaxCapacity: !Ref MaxCapacity
      MinCapacity: !Ref MinCapacity
      ResourceId: !Sub service/${EnvironmentName}-bound-cluster/${EnvironmentName}-bound-service
      RoleARN: !GetAtt AutoScalingRole.Arn
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  ECSServiceScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    DependsOn: ECSServiceScalingTarget
    Properties:
      PolicyName: !Sub ${EnvironmentName}-bound-cpu-target
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref ECSServiceScalingTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: !Ref CpuTarget
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        ScaleInCooldown: 60
        ScaleOutCooldown: 60

  CodeDeployServiceRole:
    Type: AWS::IAM::Role
    Condition: UseCodeDeploy
    Properties:
      RoleName: !Sub ${EnvironmentName}-bound-codedeploy-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: codedeploy.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CodeDeployForEcs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ecs:CreateDeployment
                  - ecs:DescribeServices
                  - ecs:UpdateService
                Resource: "*"
              - Effect: Allow
                Action:
                  - elasticloadbalancing:DescribeListeners
                  - elasticloadbalancing:DescribeRules
                  - elasticloadbalancing:DescribeTargetGroups
                  - elasticloadbalancing:ModifyListener
                  - elasticloadbalancing:ModifyRule
                Resource: "*"
              - Effect: Allow
                Action:
                  - cloudwatch:DescribeAlarms
                  - cloudwatch:PutMetricAlarm
                  - cloudwatch:DeleteAlarms
                Resource: "*"
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource: "*"
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: "*"

  CodeDeployApplication:
    Type: AWS::CodeDeploy::Application
    Condition: UseCodeDeploy
    Properties:
      ApplicationName: !Sub ${EnvironmentName}-bound
      ComputePlatform: ECS

  CodeDeployDeploymentGroup:
    Type: AWS::CodeDeploy::DeploymentGroup
    Condition: UseCodeDeploy
    DependsOn:
      - ECSService
      - ALBListener
      - ALBTestListener
    Properties:
      ApplicationName: !Ref CodeDeployApplication
      DeploymentGroupName: !Sub ${EnvironmentName}-bound
      ServiceRoleArn: !GetAtt CodeDeployServiceRole.Arn
      DeploymentConfigName: CodeDeployDefault.ECSAllAtOnce
      DeploymentStyle:
        DeploymentType: BLUE_GREEN
        DeploymentOption: WITH_TRAFFIC_CONTROL
      BlueGreenDeploymentConfiguration:
        DeploymentReadyOption:
          ActionOnTimeout: CONTINUE_DEPLOYMENT
          WaitTimeInMinutes: 0
        TerminateBlueInstancesOnDeploymentSuccess:
          Action: TERMINATE
          TerminationWaitTimeInMinutes: 5
      LoadBalancerInfo:
        TargetGroupPairInfoList:
          - TargetGroups:
              - Name: !GetAtt BlueTargetGroup.TargetGroupName
              - Name: !GetAtt GreenTargetGroup.TargetGroupName
            ProdTrafficRoute:
              ListenerArns:
                - !Ref ALBListener
            TestTrafficRoute:
              ListenerArns:
                - !Ref ALBTestListener
      ECSServices:
        - ClusterName: !Sub ${EnvironmentName}-bound-cluster
          ServiceName: !Sub ${EnvironmentName}-bound-service

Outputs:
  ALBDNSName:
    Value: !GetAtt ALB.DNSName
    Export:
      Name: !Sub ${EnvironmentName}-ALBDNSName

  ECSSecurityGroup:
    Value: !Ref ECSSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-ECSSecurityGroup

  ClusterName:
    Value: !Ref ECSCluster
    Export:
      Name: !Sub ${EnvironmentName}-ClusterName
